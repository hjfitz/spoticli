# [1] https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema
pr:
- feature/*

# Each stage has it's own container - 
# if you change something in one stage, it doesn't do anything for the other stage
stages:
#Â Start with checking the code and running all tests
- stage: weird
  jobs:
  - job: Send_init
    steps:
    - bash: yarn add request request-promise
    - bash: node .pipelines/send-result.js $(SERVER_URL) init "$(Build.Repository.ID)-$(Build.BuildId)-$(Build.SourceBranchName)" $(Build.SourceBranchName) "$(date +%s)"
- stage: PR_CodeQuality
  jobs: 
  - job: TSLint
    displayName: ðŸ§¹ - Running TSLint
    steps: 
      - bash: echo [ETS] Attempting to run linter...
      - bash: yarn
      - bash: yarn lint
  - job: Testing
    displayName: ðŸ“š - Testing Code
    steps:
      - bash: echo [ETS] Testing code...
      - bash: yarn
      - bash: yarn test
- stage: PR_Test
  jobs: 
  - job: Testing
    displayName: TEST PLS
    steps:
      - bash: echo $(Build.BuildId) 
      - bash: echo $(Build.Repository.ID) 
      - bash: echo $(Build.Repository.Name)
  - job: Send_a_result
    displayName: phoning home
    steps:
    - bash: yarn add request request-promise
    - bash: node .pipelines/send-result.js $(SERVER_URL) phone "$(Build.Repository.ID)-$(Build.BuildId)-$(Build.SourceBranchName)" $(Build.SourceBranchName) "some more results"
- stage: PR_Security
  jobs: 
  - job: StaticAnalysis
    displayName: ðŸ”Ž - Analysing Source Code
    steps:
      - bash: ./.pipelines/ssca.sh
  - job: Leaks
    displayName: ðŸ”‘ - Checking for committed keys
    steps:
      - bash: ./.pipelines/check-leaks.sh
- stage: PR_End
  jobs:
  - job: SendEnd
    steps:
    - bash: yarn add request request-promise
    - bash: node .pipelines/send-result.js $(SERVER_URL) end "$(Build.Repository.ID)-$(Build.BuildId)-$(Build.SourceBranchName)" $(Build.SourceBranchName) "$(date +%s)"
